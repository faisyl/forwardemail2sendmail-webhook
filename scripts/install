#!/bin/bash

source /usr/share/yunohost/helpers
source _common.sh

#=================================================
# INITIALIZE AND STORE SETTINGS
#=================================================

ynh_app_setting_set --app="$app" --key=domain --value="$domain"
ynh_app_setting_set --app="$app" --key=path --value="$path"
ynh_app_setting_set --app="$app" --key=admin --value="$admin"
ynh_app_setting_set --app="$app" --key=webhook_key --value="$webhook_key"
ynh_app_setting_set --app="$app" --key=backend_type --value="$backend_type"
ynh_app_setting_set --app="$app" --key=smtp_host --value="$smtp_host"
ynh_app_setting_set --app="$app" --key=smtp_port --value="$smtp_port"
ynh_app_setting_set --app="$app" --key=smtp_user --value="$smtp_user"
ynh_app_setting_set --app="$app" --key=smtp_pass --value="$smtp_pass"
ynh_app_setting_set --app="$app" --key=smtp_skip_verify --value="$smtp_skip_verify"

#=================================================
# VERIFY POSTFIX IS INSTALLED
#=================================================
ynh_script_progression --message="Verifying Postfix installation..." --weight=1

if ! command -v sendmail &> /dev/null; then
    ynh_print_warn "Sendmail not found. Please ensure Postfix is installed."
fi

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression --message="Setting up source files..." --weight=1

# Download and copy application source
download_app_source "$install_dir"

# Set permissions
chown -R "$app:www-data" "$install_dir"

#=================================================
# BUILD APPLICATION
#=================================================
ynh_script_progression --message="Building Go application..." --weight=5

mkdir -p "$install_dir/bin"
build_go_app "$install_dir" "$app"

#=================================================
# SYSTEM CONFIGURATION
#=================================================
ynh_script_progression --message="Adding system configurations related to $app..." --weight=1

# Create systemd service
ynh_config_add_systemd

# Create nginx config
ynh_config_add_nginx

# Create log directory
mkdir -p "/var/log/$app"
chown -R "$app:$app" "/var/log/$app"

# Use logrotate to manage application logfile(s)
ynh_config_add_logrotate

yunohost service add "$app" --description="Go web application" --log="/var/log/$app/$app.log"

# Add logo to portal
ynh_add_portal_icon

# Add application user to postdrop group to allow sendmail/postdrop usage
if ! groups "$app" | grep -q "\bpostdrop\b"; then
    usermod -a -G postdrop "$app"
fi

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression --message="Starting $app's systemd service..." --weight=1

ynh_systemctl --service="$app" --action="start" --log_path="/var/log/$app/$app.log"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression --message="Installation of $app completed" --last
